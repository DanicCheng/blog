"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var _={},ArrayProto=Array.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,nativeToString=ObjProto.toString,nativeHasOwnProperty=Object.prototype.hasOwnProperty,nativeForEach=ArrayProto.forEach,nativeIsArray=Array.isArray,breaker={};_.each=function(e,t,n){if(null==e)return!1;if(nativeForEach&&e.forEach===nativeForEach)e.forEach(t,n);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(n,e[i],i,e)===breaker)return!1}else for(var r in e)if(nativeHasOwnProperty.call(e,r)&&t.call(n,e[r],r,e)===breaker)return!1},_.extend=function(e){return _.each(slice.call(arguments,1),function(t){for(var n in t)void 0!==t[n]&&(e[n]=t[n])}),e},_.extend2Layers=function(e){return _.each(slice.call(arguments,1),function(t){for(var n in t)void 0!==t[n]&&(_.isObject(t[n])&&_.isObject(e[n])?_.extend(e[n],t[n]):e[n]=t[n])}),e},_.isArray=nativeIsArray||function(e){return"[object Array]"===nativeToString.call(e)},_.isFunction=function(e){try{return"function"==typeof e}catch(e){return!1}},_.isPromise=function(e){return"[object Promise]"===nativeToString.call(e)&&null!==e},_.isObject=function(e){return"[object Object]"===nativeToString.call(e)&&null!==e},_.isEmptyObject=function(e){if(_.isObject(e)){for(var t in e)if(nativeHasOwnProperty.call(e,t))return!1;return!0}return!1},_.isUndefined=function(e){return void 0===e},_.isString=function(e){return"[object String]"===nativeToString.call(e)},_.isDate=function(e){return"[object Date]"===nativeToString.call(e)},_.isBoolean=function(e){return"[object Boolean]"===nativeToString.call(e)},_.isNumber=function(e){return"[object Number]"===nativeToString.call(e)&&/[\d\.]+/.test(String(e))},_.isJSONString=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},_.decodeURIComponent=function(e){var t="";try{t=decodeURIComponent(e)}catch(n){t=e}return t},_.encodeDates=function(e){return _.each(e,function(t,n){_.isDate(t)?e[n]=_.formatDate(t):_.isObject(t)&&(e[n]=_.encodeDates(t))}),e},_.formatDate=function(e){function t(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+((n=e.getMilliseconds())<100&&9<n?"0"+n:n<10?"00"+n:n);var n},_.searchObjDate=function(e){try{(_.isObject(e)||_.isArray(e))&&_.each(e,function(t,n){_.isObject(t)||_.isArray(t)?_.searchObjDate(e[n]):_.isDate(t)&&(e[n]=_.formatDate(t))})}catch(e){logger.warn(e)}},_.UUID=function(){var e=(new Date).getTime();return String(Math.random()).replace(".","").slice(1,11)+"-"+e},_.UUIDv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})};var logger="object"===_typeof(logger)?logger:{};logger.info=function(){if("object"===("undefined"==typeof console?"undefined":_typeof(console))&&console.log&&logger.enabled)try{return console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}},logger.warn=function(){if("object"===("undefined"==typeof console?"undefined":_typeof(console))&&console.log&&logger.enabled)try{return console.warn.apply(console,arguments)}catch(e){console.warn(arguments[0])}};var currentPlatform,KEY_NAME_MATCH_REGEX=/^[a-zA-Z][a-zA-Z0-9_]{0,49}$/,PropertyChecker=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"stripProperties",value:function(e){return _.isObject(e)&&_.each(e,function(e,t){_.isString(e)||_.isNumber(e)||_.isDate(e)||_.isBoolean(e)||_.isArray(e)||logger.warn("\u60a8\u7684\u6570\u636e-",t,e,"-\u683c\u5f0f\u4e0d\u6ee1\u8db3\u8981\u6c42\uff0c\u53ef\u80fd\u65e0\u6cd5\u6b63\u786e\u5165\u5e93")}),e}},{key:"_checkPropertiesKey",value:function(e){var t=!0;return _.each(e,function(e,n){KEY_NAME_MATCH_REGEX.test(n)||(logger.warn("\u4e0d\u5408\u6cd5\u7684 KEY \u503c: "+n),t=!1)}),t}},{key:"event",value:function(e){return!(!_.isString(e)||!KEY_NAME_MATCH_REGEX.test(e))||(logger.warn("\u8bf7\u68c0\u67e5\u53c2\u6570\u683c\u5f0f, eventName \u5fc5\u987b\u662f\u82f1\u6587\u5b57\u6bcd\u5f00\u5934, \u5305\u542b\u5b57\u6bcd\u548c\u6570\u5b57\u548c\u4e0b\u5212\u7ebf\u7684\u4e0d\u8d85\u8fc750\u4e2a\u5b57\u7b26\u7684\u5b57\u7b26\u4e32: "+e),!1)}},{key:"propertyName",value:function(e){return!(!_.isString(e)||!KEY_NAME_MATCH_REGEX.test(e))||(logger.warn("\u8bf7\u68c0\u67e5\u53c2\u6570\u683c\u5f0f, propertyName \u5fc5\u987b\u662f\u82f1\u6587\u5b57\u6bcd\u5f00\u5934, \u5305\u542b\u5b57\u6bcd\u548c\u6570\u5b57\u548c\u4e0b\u5212\u7ebf\u7684\u4e0d\u8d85\u8fc750\u4e2a\u5b57\u7b26\u7684\u5b57\u7b26\u4e32: "+e),!1)}},{key:"properties",value:function(e){return this.stripProperties(e),!(e&&(_.isObject(e)?!this._checkPropertiesKey(e)&&(logger.warn("\u8bf7\u68c0\u67e5\u53c2\u6570\u683c\u5f0f, properties \u7684 key \u53ea\u80fd\u4ee5\u5b57\u6bcd\u5f00\u5934\uff0c\u5305\u542b\u6570\u5b57\u3001\u5b57\u6bcd\u548c\u4e0b\u5212\u7ebf _\uff0c\u957f\u5ea6\u6700\u5927\u4e3a50\u4e2a\u5b57\u7b26"),1):(logger.warn("properties \u53ef\u4ee5\u6ca1\u6709\uff0c\u4f46\u6709\u7684\u8bdd\u5fc5\u987b\u662f\u5bf9\u8c61"),1)))}},{key:"propertiesMust",value:function(e){return this.stripProperties(e),void 0===e||!_.isObject(e)||_.isEmptyObject(e)?(logger.warn("properties\u5fc5\u987b\u662f\u5bf9\u8c61\u4e14\u6709\u503c"),!1):!!this._checkPropertiesKey(e)||(logger.warn("\u8bf7\u68c0\u67e5\u53c2\u6570\u683c\u5f0f, properties \u7684 key \u53ea\u80fd\u4ee5\u5b57\u6bcd\u5f00\u5934\uff0c\u5305\u542b\u6570\u5b57\u3001\u5b57\u6bcd\u548c\u4e0b\u5212\u7ebf _\uff0c\u957f\u5ea6\u6700\u5927\u4e3a50\u4e2a\u5b57\u7b26"),!1)}},{key:"userId",value:function(e){return!(!_.isString(e)||!/^.{1,64}$/.test(e))||(logger.warn("\u7528\u6237 id \u5fc5\u987b\u662f\u4e0d\u80fd\u4e3a\u7a7a\uff0c\u4e14\u5c0f\u4e8e 64 \u4f4d\u7684\u5b57\u7b26\u4e32"),!1)}},{key:"userAddProperties",value:function(e){if(!this.propertiesMust(e))return!1;for(var t in e)if(!_.isNumber(e[t]))return logger.warn("userAdd \u7684\u5c5e\u6027\u9700\u8981\u4e3a\u6570\u503c\u7c7b\u578b"),!1;return!0}},{key:"userAppendProperties",value:function(e){if(!this.propertiesMust(e))return!1;for(var t in e)if(!_.isArray(e[t]))return logger.warn("userAppend \u7684\u5c5e\u6027\u9700\u8981\u4e3a Array \u7c7b\u578b"),!1;return!0}}]),e}(),Config={LIB_VERSION:"1.6.0",LIB_NAME:"MG",PERSISTENCE_NAME:"R_PERSISTENCE_NAME",PERSISTENCE_ASYNC:!1},AutoTrackBridge=function e(t,n,i){var s=this;_classCallCheck(this,e),this.taInstance=t,GameGlobal[this.taInstance.name]=t,this.config=n||{};var r=i.getLaunchOptionsSync();r&&r.scene&&this.taInstance._setAutoTrackProperties({"#scene":r.scene}),i.onShow(function(e){s.config.appHide&&s.taInstance.timeEvent("ta_mg_hide"),e&&e.scene&&s.taInstance._setAutoTrackProperties({"#scene":e.scene}),s.config.appShow&&s.taInstance._internalTrack("ta_mg_show")}),i.onHide(function(){s.config.appHide&&s.taInstance._internalTrack("ta_mg_hide")})},AutoTrackBridgeVivo=function e(t,n){var i=this;_classCallCheck(this,e),this.taInstance=t,this.config=n||{},this.config.appShow&&this.taInstance._internalTrack("ta_mg_show"),this.config.appHide&&this.taInstance.timeEvent("ta_mg_hide"),qg.onShow(function(){i.config.appHide&&i.taInstance.timeEvent("ta_mg_hide"),i.config.appShow&&i.taInstance._internalTrack("ta_mg_show")}),qg.onHide(function(){i.config.appHide&&i.taInstance._internalTrack("ta_mg_hide")})},AutoTrackBridgeOppo=function e(t,n){var i=this;_classCallCheck(this,e),this.taInstance=t,this.config=n||{},this.config.appShow&&this.taInstance._internalTrack("ta_mg_show"),this.config.appHide&&this.taInstance.timeEvent("ta_mg_hide"),qg.onShow(function(){i.config.appHide&&i.taInstance.timeEvent("ta_mg_hide"),i.config.appShow&&i.taInstance._internalTrack("ta_mg_show")}),qg.onHide(function(){i.config.appHide&&i.taInstance._internalTrack("ta_mg_hide")})},CurrentPlatformVivo=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"getStorage",value:function(e){qg.getStorage({key:e.key,success:function(t){var n={};n.data=t,e.success(n)},fail:function(){e.fail({})}})}},{key:"setStorage",value:function(e){qg.setStorage({key:e.key,value:e.data})}},{key:"getSystemInfo",value:function(e){qg.getSystemInfo({success:function(t){var n=t,i=[t.osType,t.osVersionName].join(" ");n.brand=t.manufacturer,n.system=i,e.success(n)},complete:function(){e.complete()}})}},{key:"getNetworkType",value:function(e){qg.getNetworkType({success:function(t){var n=t;n.networkType=t.type,e.success(n)},complete:function(){e.complete()}})}},{key:"onNetworkStatusChange",value:function(e){qg.subscribeNetworkStatus({callback:function(t){var n=t;n.networkType=t.type,e(n)}})}},{key:"request",value:function(e){var t={"content-type":"application/json"};return e.header&&(t=e.header),qg.request({url:e.url,data:e.data,method:e.method,header:t,success:function(t){e.success(t)},fail:function(t){e.fail(t)}})}}]),e}(),currentPlatformVivo=new CurrentPlatformVivo,CurrentPlatformOppo=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"getStorageSync",value:function(e){return localStorage.getItem(e)}},{key:"setStorage",value:function(e){localStorage.setItem(e.key,e.data)}},{key:"getSystemInfo",value:function(e){qg.getSystemInfo({success:function(t){e.success(t)},complete:function(){e.complete()}})}},{key:"getNetworkType",value:function(e){qg.getNetworkType({success:function(t){e.success(t)},complete:function(){e.complete()}})}},{key:"onNetworkStatusChange",value:function(e){qg.onNetworkStatusChange({callback:function(t){e(t)}})}},{key:"request",value:function(e){var t=new XMLHttpRequest;if(e.header)for(var n in e.header)t.setRequestHeader(n,e.header[n]);else t.setRequestHeader("content-type","application/json");return t.open(e.method,e.url),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var n={statusCode:200};_.isJSONString(t.responseText)&&(n.data=JSON.parse(t.responseText)),e.success(n)}},t.ontimeout=function(){e.fail({errMsg:"timeout"})},t.send(e.data),t}},{key:"getLaunchOptionsSync",value:function(){return qg.getLaunchOptionsSync()}}]),e}(),currentPlatformOppo=new CurrentPlatformOppo,PlatformAPI=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"init",value:function(e){cc.sys.platform===cc.sys.WECHAT_GAME?(currentPlatform=wx,e.persistenceName="thinkingdata_wechat_game",e.asyncPersistence=!1):cc.sys.platform===cc.sys.BAIDU_GAME?(currentPlatform=swan,e.persistenceName="thinkingdata_swan_game",e.asyncPersistence=!1):cc.sys.platform===cc.sys.VIVO_GAME?(currentPlatform=currentPlatformVivo,e.persistenceName="thinkingdata_qg_vivo_game",e.asyncPersistence=!0):cc.sys.platform===cc.sys.OPPO_GAME&&(currentPlatform=currentPlatformOppo,e.persistenceName="thinkingdata_qg_oppo_game",e.asyncPersistence=!1)}},{key:"getStorage",value:function(e,t,n){if(!t){var i=currentPlatform.getStorageSync(e);return _.isJSONString(i)?JSON.parse(i):{}}currentPlatform.getStorage({key:e,success:function(e){var t=_.isJSONString(e.data)?JSON.parse(e.data):{};n(t)},fail:function(){logger.warn("getStorage faild"),n({})}})}},{key:"setStorage",value:function(e,t){currentPlatform.setStorage({key:e,data:t})}},{key:"getSystemInfo",value:function(e){currentPlatform.getSystemInfo({success:function(t){cc.sys.platform===cc.sys.WECHAT_GAME?t.mp_platform="wechat":cc.sys.platform===cc.sys.BAIDU_GAME?t.mp_platform=t.host:cc.sys.platform===cc.sys.VIVO_GAME?t.mp_platform="vivo_qg":cc.sys.platform===cc.sys.OPPO_GAME&&(t.mp_platform="oppo_qg"),e.success(t)},complete:function(){e.complete()}})}},{key:"getNetworkType",value:function(e){currentPlatform.getNetworkType({success:function(t){e.success(t)},complete:function(){e.complete()}})}},{key:"onNetworkStatusChange",value:function(e){currentPlatform.onNetworkStatusChange(e)}},{key:"request",value:function(e){return currentPlatform.request(e)}},{key:"initAutoTrackInstance",value:function(e,t){return _.isObject(t.autoTrack)&&(t.autoTrack.isPlugin=t.is_plugin),cc.sys.platform===cc.sys.WECHAT_GAME||cc.sys.platform===cc.sys.BAIDU_GAME?new AutoTrackBridge(e,t.autoTrack,currentPlatform):cc.sys.platform===cc.sys.VIVO_GAME?new AutoTrackBridgeVivo(e,t.autoTrack,currentPlatform):cc.sys.platform===cc.sys.OPPO_GAME?new AutoTrackBridgeOppo(e,t.autoTrack,currentPlatform):void 0}},{key:"getAppOptions",value:function(e){var t={};try{t=currentPlatform.getLaunchOptionsSync()}catch(e){logger.warn("Cannot get launch options.")}if(_.isFunction(e)&&_.isFunction(currentPlatform.onShow))try{currentPlatform.onShow(e)}catch(e){logger.warn("Cannot register onAppShow callback.")}return t}},{key:"showDebugToast",value:function(e){cc.sys.platform===cc.sys.WECHAT_GAME?wx.showToast({title:e,icon:"none",duration:2e3}):cc.sys.platform===cc.sys.BAIDU_GAME?swan.showToast({title:e,icon:"none",duration:2e3}):cc.sys.platform===cc.sys.OPPO_GAME?qg.showToast({title:e,icon:"none",duration:2e3}):cc.sys.platform===cc.sys.VIVO_GAME&&qg.showToast({message:e,duration:0})}}]),e}(),HttpTask=function(){function e(t,n,i,s,r){_classCallCheck(this,e),this.data=t,this.serverUrl=n,this.callback=r,this.tryCount=_.isNumber(i)?i:1,this.timeout=_.isNumber(s)?s:3e3}return _createClass(e,[{key:"run",value:function(){var e=this,t=PlatformAPI.request({url:this.serverUrl,method:"POST",data:this.data,success:function(t){e.onSuccess(t)},fail:function(t){e.onFailed(t)}});setTimeout(function(){(_.isObject(t)||_.isPromise(t))&&_.isFunction(t.abort)&&t.abort()},this.timeout)}},{key:"onSuccess",value:function(e){if(200===e.statusCode){var t;switch(e.data.code){case 0:t="success";break;case-1:t="invalid data";break;case-2:t="invalid APP ID";break;default:t="Unknown return code"}this.callback({code:e.data.code,msg:t})}else this.callback({code:-3,msg:e.statusCode})}},{key:"onFailed",value:function(e){0<--this.tryCount?this.run():this.callback({code:-3,msg:e.errMsg})}}]),e}(),HttpTaskDebug=function(){function e(t,n,i,s,r,a,o){_classCallCheck(this,e),this.data=t,this.serverDebugUrl=n,this.callback=o,this.tryCount=_.isNumber(i)?i:1,this.timeout=_.isNumber(s)?s:3e3,this.dryrun=r,this.deviceId=a}return _createClass(e,[{key:"run",value:function(){var e=this,t="appid="+this.data["#app_id"]+"&source=client&dryRun="+this.dryrun+"&deviceId="+this.deviceId+"&data="+encodeURIComponent(JSON.stringify(this.data.data[0])),n=PlatformAPI.request({url:this.serverDebugUrl,method:"POST",data:t,header:{"content-type":"application/x-www-form-urlencoded"},success:function(t){e.onSuccess(t)},fail:function(t){e.onFailed(t)}});setTimeout(function(){(_.isObject(n)||_.isPromise(n))&&_.isFunction(n.abort)&&n.abort()},this.timeout)}},{key:"onSuccess",value:function(e){if(200===e.statusCode){var t;if(0===e.data.errorLevel)t="Verify data success.";else if(1===e.data.errorLevel){for(var n=e.data.errorProperties,i="",s=0;s<n.length;s++){var r=n[s].errorReason;i=i+" propertyName:"+n[s].propertyName+" errorReasons:"+r+"\n"}t="Debug data error. errorLevel:"+e.data.errorLevel+" reason:"+i}else 2!==e.data.errorLevel&&-1!==e.data.errorLevel||(t="Debug data error. errorLevel:"+e.data.errorLevel+" reason:"+e.data.errorReasons);logger.info(t),this.callback({code:e.data.errorLevel,msg:t})}else this.callback({code:-3,msg:e.statusCode})}},{key:"onFailed",value:function(e){0<--this.tryCount?this.run():this.callback({code:-3,msg:e.errMsg})}}]),e}(),SenderQueue=function(){function e(){_classCallCheck(this,e),this.items=[],this.isRunning=!1,this.showDebug=!1}return _createClass(e,[{key:"enqueue",value:function(e,t,n){var i,s=this;i="debug"===n.debugMode?new HttpTaskDebug(e,t,n.maxRetries,n.sendTimeout,0,n.deviceId,function(e){s.isRunning=!1,_.isFunction(n.callback)&&n.callback(e),s._runNext(),!1===s.showDebug&&(0!==e.code&&1!==e.code&&2!==e.code||(s.showDebug=!0,_.isFunction(PlatformAPI.showDebugToast)&&PlatformAPI.showDebugToast("\u5f53\u524d\u4e3a debug \u6a21\u5f0f")))}):"debugOnly"===n.debugMode?new HttpTaskDebug(e,t,n.maxRetries,n.sendTimeout,1,n.deviceId,function(e){s.isRunning=!1,_.isFunction(n.callback)&&n.callback(e),s._runNext(),!1===s.showDebug&&(0!==e.code&&1!==e.code&&2!==e.code||(s.showDebug=!0,_.isFunction(PlatformAPI.showDebugToast)&&PlatformAPI.showDebugToast("\u5f53\u524d\u4e3a debugOnly \u6a21\u5f0f")))}):new HttpTask(JSON.stringify(e),t,n.maxRetries,n.sendTimeout,function(e){s.isRunning=!1,_.isFunction(n.callback)&&n.callback(e),s._runNext()}),this.items.push(i),this._runNext()}},{key:"_dequeue",value:function(){return this.items.shift()}},{key:"_runNext",value:function(){0<this.items.length&&!this.isRunning&&(this.isRunning=!0,this._dequeue().run())}}]),e}(),senderQueue=new SenderQueue,DEFAULT_CONFIG={name:"thinkingdata",is_plugin:!1,maxRetries:3,sendTimeout:3e3,enablePersistence:!0,asyncPersistence:Config.PERSISTENCE_ASYNC,enableLog:!0,strict:!1,debugMode:"none"},systemInformation={properties:{"#lib":Config.LIB_NAME,"#lib_version":Config.LIB_VERSION},initDeviceId:function(e){_.isString(e)&&(this.properties["#device_id"]=e)},getSystemInfo:function(e){var t=this;PlatformAPI.onNetworkStatusChange(function(e){t.properties["#network_type"]=e.networkType}),PlatformAPI.getNetworkType({success:function(e){t.properties["#network_type"]=e.networkType},complete:function(){PlatformAPI.getSystemInfo({success:function(e){var n={"#manufacturer":e.brand,"#device_model":e.model,"#screen_width":Number(e.screenWidth),"#screen_height":Number(e.screenHeight),"#os":e.system.split(" ")[0],"#os_version":e.system.split(" ")[1],"#mp_platform":e.mp_platform};_.extend(t.properties,n)},complete:function(){e()}})}})}},ThinkingDataPersistence=function(){function e(t,n){var i=this;_classCallCheck(this,e),this.enabled=t.enablePersistence,this.enabled?(t.isChildInstance?this.name=t.persistenceName+"_"+t.name:this.name=t.persistenceName,t.asyncPersistence?(this._state={},PlatformAPI.getStorage(this.name,!0,function(e){i._state=_.extend2Layers({},e,i._state),i._init(t,n),i._save()})):(this._state=PlatformAPI.getStorage(this.name)||{},this._init(t,n))):(this._state={},this._init(t,n))}return _createClass(e,[{key:"_init",value:function(e,t){this.getDistinctId()||this.setDistinctId(_.UUID()),e.isChildInstance||(this.getDeviceId()||this._setDeviceId(_.UUID()),systemInformation.initDeviceId(this.getDeviceId())),this.initComplete=!0,"function"==typeof t&&t(),this._save()}},{key:"_save",value:function(){this.enabled&&this.initComplete&&PlatformAPI.setStorage(this.name,JSON.stringify(this._state))}},{key:"_set",value:function(e,t){var n,i=this;"string"==typeof e?(n={})[e]=t:"object"===_typeof(e)&&(n=e),_.each(n,function(e,t){i._state[t]=e}),this._save()}},{key:"setEventTimer",value:function(e,t){var n=this._state.event_timers||{};n[e]=t,this._set("event_timers",n)}},{key:"removeEventTimer",value:function(e){var t=(this._state.event_timers||{})[e];return _.isUndefined(t)||(delete this._state.event_timers[e],this._save()),t}},{key:"getDeviceId",value:function(){return this._state.device_id}},{key:"_setDeviceId",value:function(e){this.getDeviceId()?logger.warn("cannot modify the device id."):this._set("device_id",e)}},{key:"getDistinctId",value:function(){return this._state.distinct_id}},{key:"setDistinctId",value:function(e){this._set("distinct_id",e)}},{key:"getAccountId",value:function(){return this._state.account_id}},{key:"setAccountId",value:function(e){this._set("account_id",e)}},{key:"getSuperProperties",value:function(){return this._state.props||{}}},{key:"setSuperProperties",value:function(e,t){var n=t?e:_.extend(this.getSuperProperties(),e);this._set("props",n)}}]),e}(),ThinkingDataAPI=function(){function e(t){_classCallCheck(this,e),_.isObject(t)?this.config=_.extend({},DEFAULT_CONFIG,t):this.config=DEFAULT_CONFIG,PlatformAPI.init(this.config),this._init(this.config)}return _createClass(e,[{key:"_init",value:function(e){var t=this;if(this.name=e.name,this.appId=e.appid||e.appId,this.serverUrl=e.server_url+"/sync_xcx",this.serverDebugUrl=e.server_url+"/data_debug",this.autoTrackProperties={},this._queue=[],e.isChildInstance)this._state={};else if(logger.enabled=e.enableLog,this.instances=[],this._state={getSystemInfo:!1,initComplete:!1},systemInformation.getSystemInfo(function(){t._updateState({getSystemInfo:!0})}),e.autoTrack)this.autoTrack=PlatformAPI.initAutoTrackInstance(this,e);else{var n=PlatformAPI.getAppOptions(function(e){e&&e.scene&&t._setAutoTrackProperties({"#scene":e.scene})});n.scene&&this._setAutoTrackProperties({"#scene":n.scene})}this.store=new ThinkingDataPersistence(e,function(){t.config.asyncPersistence&&_.isFunction(t.config.persistenceComplete)&&t.config.persistenceComplete(t),t._updateState()})}},{key:"initInstance",value:function(t,n){if(this.config.isChildInstance)logger.warn("initInstance() cannot be called on child instance");else if(_.isString(t)&&t!==this.name&&_.isUndefined(this[t])){var i=new e(_.extend({},this.config,{enablePersistence:!1,isChildInstance:!0,name:t},n));this[t]=i,this.instances.push(t),this[t]._state=this._state}else logger.warn("initInstance() failed due to the name is invalid: "+t)}},{key:"lightInstance",value:function(e){return this[e]}},{key:"_setAutoTrackProperties",value:function(e){_.extend(this.autoTrackProperties,e)}},{key:"init",value:function(){if(this._state.initComplete)return!1;this._updateState({initComplete:!0})}},{key:"_isReady",value:function(){return this._state.getSystemInfo&&this._state.initComplete&&this.store.initComplete&&this.getDeviceId()}},{key:"_updateState",value:function(e){var t=this;_.isObject(e)&&_.extend(this._state,e),this._onStateChange(),_.each(this.instances,function(e){t[e]._onStateChange()})}},{key:"_onStateChange",value:function(){var e=this;this._isReady()&&this._queue&&0<this._queue.length&&(_.each(this._queue,function(t){e[t[0]].apply(e,slice.call(t[1]))}),this._queue=[])}},{key:"_sendRequest",value:function(e,t){t=_.isDate(t)?t:new Date;var n={data:[{"#type":e.type,"#time":_.formatDate(t),"#distinct_id":this.store.getDistinctId()}]};if(this.store.getAccountId()&&(n.data[0]["#account_id"]=this.store.getAccountId()),"track"===e.type){n.data[0]["#event_name"]=e.eventName,n.data[0].properties=_.extend({"#zone_offset":0-t.getTimezoneOffset()/60},systemInformation.properties,this.autoTrackProperties,this.store.getSuperProperties(),this.dynamicProperties?this.dynamicProperties():{});var i=this.store.removeEventTimer(e.eventName);if(!_.isUndefined(i)){var s=(new Date).getTime()-i;n.data[0].properties["#duration"]=parseFloat((s/1e3).toFixed(3))}}else n.data[0].properties={};_.isObject(e.properties)&&!_.isEmptyObject(e.properties)&&_.extend(n.data[0].properties,e.properties),_.searchObjDate(n.data[0]),1<this.config.maxRetries&&(n.data[0]["#uuid"]=_.UUIDv4()),n["#app_id"]=this.appId,logger.info(JSON.stringify(n,null,4));var r="debug"===this.config.debugMode||"debugOnly"===this.config.debugMode?this.serverDebugUrl:this.serverUrl;senderQueue.enqueue(n,r,{maxRetries:this.config.maxRetries,sendTimeout:this.config.sendTimeout,callback:e.onComplete,debugMode:this.config.debugMode,deviceId:this.getDeviceId()})}},{key:"_isObjectParams",value:function(e){return _.isObject(e)&&_.isFunction(e.onComplete)}},{key:"track",value:function(e,t,n,i){if(this._isObjectParams(e)){var s=e;e=s.eventName,t=s.properties,n=s.time,i=s.onComplete}PropertyChecker.event(e)&&PropertyChecker.properties(t)||!this.config.strict?this._internalTrack(e,t,n,i):_.isFunction(i)&&i({code:-1,msg:"invalid parameters"})}},{key:"_internalTrack",value:function(e,t,n,i){n=_.isDate(n)?n:new Date,this._isReady()?this._sendRequest({type:"track",eventName:e,properties:t,onComplete:i},n):this._queue.push(["_internalTrack",[e,t,n,i]])}},{key:"userSet",value:function(e,t,n){if(this._isObjectParams(e)){var i=e;e=i.properties,t=i.time,n=i.onComplete}PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"user_set",properties:e,onComplete:n},t):this._queue.push(["userSet",[e,t,n]])):(logger.warn("calling userSet failed due to invalid arguments"),_.isFunction(n)&&n({code:-1,msg:"invalid parameters"}))}},{key:"userSetOnce",value:function(e,t,n){if(this._isObjectParams(e)){var i=e;e=i.properties,t=i.time,n=i.onComplete}PropertyChecker.propertiesMust(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"user_setOnce",properties:e,onComplete:n},t):this._queue.push(["userSetOnce",[e,t,n]])):(logger.warn("calling userSetOnce failed due to invalid arguments"),_.isFunction(n)&&n({code:-1,msg:"invalid parameters"}))}},{key:"userUnset",value:function(e,t,n){if(this._isObjectParams(s)){var i=s;e=i.property,n=i.time,t=i.onComplete}if(PropertyChecker.propertyName(e)||!this.config.strict)if(n=_.isDate(n)?n:new Date,this._isReady()){var s={};s[e]=0,this._sendRequest({type:"user_unset",properties:s,onComplete:t},n)}else this._queue.push(["userUnset",[e,t,n]]);else logger.warn("calling userUnset failed due to invalid arguments"),_.isFunction(t)&&t({code:-1,msg:"invalid parameters"})}},{key:"userDel",value:function(e,t){if(this._isObjectParams(e)){var n=e;e=n.time,t=n.onComplete}e=_.isDate(e)?e:new Date,this._isReady()?this._sendRequest({type:"user_del",onComplete:t},e):this._queue.push(["userDel",[e,t]])}},{key:"userAdd",value:function(e,t,n){if(this._isObjectParams(e)){var i=e;e=i.properties,t=i.time,n=i.onComplete}PropertyChecker.userAddProperties(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"user_add",properties:e,onComplete:n},t):this._queue.push(["userAdd",[e,t,n]])):(logger.warn("calling userAdd failed due to invalid arguments"),_.isFunction(n)&&n({code:-1,msg:"invalid parameters"}))}},{key:"userAppend",value:function(e,t,n){if(this._isObjectParams(e)){var i=e;e=i.properties,t=i.time,n=i.onComplete}PropertyChecker.userAppendProperties(e)||!this.config.strict?(t=_.isDate(t)?t:new Date,this._isReady()?this._sendRequest({type:"user_append",properties:e,onComplete:n},t):this._queue.push(["userAppend",[e,t,n]])):(logger.warn("calling userAppend failed due to invalid arguments"),_.isFunction(n)&&n({code:-1,msg:"invalid parameters"}))}},{key:"authorizeOpenID",value:function(e){this.identify(e)}},{key:"identify",value:function(e){if("number"==typeof e)e=String(e);else if("string"!=typeof e)return!1;this.store.setDistinctId(e)}},{key:"getDistinctId",value:function(){return this.store.getDistinctId()}},{key:"login",value:function(e){if("number"==typeof e)e=String(e);else if("string"!=typeof e)return!1;this.store.setAccountId(e)}},{key:"getAccountId",value:function(){return this.store.getAccountId()}},{key:"logout",value:function(){this.store.setAccountId(null)}},{key:"setSuperProperties",value:function(e){PropertyChecker.propertiesMust(e)||!this.config.strict?this.store.setSuperProperties(e):logger.warn("setSuperProperties \u7684\u53c2\u6570\u5fc5\u987b\u662f\u5408\u6cd5\u7684\u5c5e\u6027\u503c")}},{key:"clearSuperProperties",value:function(){this.store.setSuperProperties({},!0)}},{key:"unsetSuperProperty",value:function(e){if(_.isString(e)){var t=this.getSuperProperties();delete t[e],this.store.setSuperProperties(t,!0)}}},{key:"getSuperProperties",value:function(){return this.store.getSuperProperties()}},{key:"setDynamicSuperProperties",value:function(e){"function"==typeof e?PropertyChecker.properties(e())||!this.config.strict?this.dynamicProperties=e:logger.warn("\u52a8\u6001\u516c\u5171\u5c5e\u6027\u5fc5\u987b\u8fd4\u56de\u5408\u6cd5\u7684\u5c5e\u6027\u503c"):logger.warn("setDynamicSuperProperties \u7684\u53c2\u6570\u5fc5\u987b\u662f function \u7c7b\u578b")}},{key:"timeEvent",value:function(e,t){t=_.isDate(t)?t:new Date,this._isReady()?PropertyChecker.event(e)||!this.config.strict?this.store.setEventTimer(e,t.getTime()):logger.warn("calling timeEvent failed due to invalid eventName: "+e):this._queue.push(["timeEvent",[e,t]])}},{key:"getDeviceId",value:function(){return systemInformation.properties["#device_id"]}}]),e}();window.ThinkingDataAPI=ThinkingDataAPI;